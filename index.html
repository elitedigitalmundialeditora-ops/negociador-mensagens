<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Mensagens</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; }
        .tabs { display: flex; gap: 30px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #ccc; border-radius: 6px; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .page { display: none; }
        .page.active { display: block; }
        input, select { padding: 8px; width: 250px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .msg-box { white-space: pre-line; margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; }
    </style>
</head>
<body>

<h2>Gerador de Mensagens</h2>

<!-- TABS -->
<div class="tabs">
    <div class="tab active" onclick="openTab('config')">Configura√ß√µes</div>
    <div class="tab" onclick="openTab('mensagens')">Mensagens</div>
</div>

<!-- ============================
      ABA CONFIGURA√á√ïES
============================= -->
<div id="config" class="page active">

    <h3>Configura√ß√µes por Setor</h3>

    <label>Setor:</label><br>
    <select id="setorCfg">
        <option value="play1">Play 1</option>
        <option value="play2">Play 2</option>
        <option value="play3">Play 3</option>
        <option value="play6">Play 6</option>
    </select><br>

    <label>Quita√ß√£o (%):</label><br>
    <input type="number" id="cfgQuitacao" placeholder="Ex: 10"><br>

    <label>Jun√ß√£o (%):</label><br>
    <input type="number" id="cfgJuncao" placeholder="Ex: 15"><br>

    <label>Atraso (%):</label><br>
    <input type="number" id="cfgAtraso" placeholder="Ex: 10"><br>

    <button onclick="salvarConfig()">Salvar Configura√ß√£o</button>

    <h4>Configura√ß√£o atual do setor:</h4>
    <pre id="cfgAtual"></pre>
</div>

<!-- ============================
      ABA MENSAGENS
============================= -->
<div id="mensagens" class="page">

    <h3>Gerar Mensagem</h3>

    <label>Setor:</label><br>
    <select id="setorMensagem" onchange="mostrarCampos()">
        <option value="">Selecione...</option>
        <option value="play1">Play 1</option>
        <option value="play2">Play 2</option>
        <option value="play3">Play 3</option>
        <option value="play6">Play 6</option>
    </select><br>

    <!-- CAMPOS EXCLUSIVOS PARA PLAY 1, 2 e 3 -->
    <div id="camposParcelas" style="display:none;">
        <label>Total de parcelas:</label><br>
        <input type="number" id="totalParcelas" placeholder="Ex: 20"><br>

        <label>Valor de cada parcela:</label><br>
        <input type="number" id="valorParcela" placeholder="Ex: 249.00"><br>

        <label>Parcelas em atraso:</label><br>
        <input type="number" id="parcelasAtraso" placeholder="Ex: 5"><br>
    </div>

    <!-- CAMPO ANTIGO PARA PLAY6 -->
    <div id="campoDivida" style="display:none;">
        <label>Valor total da d√≠vida:</label><br>
        <input type="number" id="divida" placeholder="Ex: 3820.30"><br>
    </div>

    <button onclick="gerarMensagem()">Gerar Mensagem</button>

    <div id="resultado" class="msg-box"></div>
</div>

<script>

/* ========== TABS ========== */
function openTab(tab) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));

    document.getElementById(tab).classList.add("active");
    event.target.classList.add("active");
}

/* Mostrar campos conforme setor */
function mostrarCampos() {
    const setor = document.getElementById("setorMensagem").value;

    if (["play1", "play2", "play3"].includes(setor)) {
        document.getElementById("camposParcelas").style.display = "block";
        document.getElementById("campoDivida").style.display = "none";
    } else {
        document.getElementById("camposParcelas").style.display = "none";
        document.getElementById("campoDivida").style.display = "block";
    }
}

/* ========== SALVAR CONFIGURA√á√ÉO ========== */
async function salvarConfig() {
    const setor = document.getElementById("setorCfg").value;

    const quitacao = Number(document.getElementById("cfgQuitacao").value);
    const juncao = Number(document.getElementById("cfgJuncao").value);
    const atraso = Number(document.getElementById("cfgAtraso").value);

    await db.collection("config").doc(setor).set({
        quitacao,
        juncao,
        atraso
    });

    alert("Configura√ß√£o salva!");
    carregarConfigAtual();
}

/* ========== MOSTRAR CONFIG ATUAL ========== */
async function carregarConfigAtual() {
    const setor = document.getElementById("setorCfg").value;
    const snap = await db.collection("config").doc(setor).get();

    if (!snap.exists) {
        document.getElementById("cfgAtual").innerText = "Nenhuma configura√ß√£o salva para este setor.";
        return;
    }

    document.getElementById("cfgAtual").innerText = JSON.stringify(snap.data(), null, 2);
}

document.getElementById("setorCfg").addEventListener("change", carregarConfigAtual);
carregarConfigAtual();

/* ========== GERAR MENSAGEM ========== */
async function gerarMensagem() {
    const setor = document.getElementById("setorMensagem").value;
    const snap = await db.collection("config").doc(setor).get();

    if (!snap.exists) return alert("Configura√ß√£o n√£o encontrada!");
    const cfg = snap.data();

    /* ==============================
          SETORES PLAY 1 / 2 / 3
    =============================== */
    if (["play1", "play2", "play3"].includes(setor)) {
        const totalParcelas = Number(document.getElementById("totalParcelas").value);
        const valorParcela = Number(document.getElementById("valorParcela").value);
        const parcelasAtraso = Number(document.getElementById("parcelasAtraso").value);

        if (!totalParcelas || !valorParcela || !parcelasAtraso)
            return alert("Preencha todos os campos das parcelas!");

        /* C√°lculo 1 ‚Äî Quita√ß√£o */
        const valorAtraso = valorParcela * parcelasAtraso;
        const valorQuitacao = valorAtraso - (valorAtraso * cfg.quitacao / 100);

        /* C√°lculo 2 ‚Äî Jun√ß√£o */
        const parcelasJuncao = parcelasAtraso + 1;
        const valorJuncao = valorParcela * parcelasJuncao;
        const valorJuncaoFinal = valorJuncao - (valorJuncao * cfg.juncao / 100);

        let mensagem =
`Segue op√ß√µes dispon√≠veis:

üìå Total de parcelas do contrato: *${totalParcelas}*
üìå Valor por parcela: *R$ ${valorParcela.toFixed(2)}*
üìå Parcelas em atraso: *${parcelasAtraso}*

1Ô∏è‚É£ *Quita√ß√£o (${cfg.quitacao}% desc.):*
Valor original das parcelas atrasadas: R$ ${valorAtraso.toFixed(2)}
Valor final com desconto: *R$ ${valorQuitacao.toFixed(2)}*

2Ô∏è‚É£ *Jun√ß√£o (${cfg.juncao}% desc.):*
Parcelas consideradas: ${parcelasJuncao}
Valor original: R$ ${valorJuncao.toFixed(2)}
Valor final com desconto: *R$ ${valorJuncaoFinal.toFixed(2)}*

Qual op√ß√£o prefere seguir?`;

        document.getElementById("resultado").innerText = mensagem;
        navigator.clipboard.writeText(mensagem);
        return;
    }

    /* ==============================
          SETOR PLAY 6 (antigo)
    =============================== */
    const divida = parseFloat(document.getElementById("divida").value);

    let mensagem = `Valor do d√©bito atualizado: *R$ ${divida.toFixed(2)}*\n\n`;

    if (cfg.quitacao > 0) {
        let valor = divida - divida * (cfg.quitacao / 100);
        mensagem += `1Ô∏è‚É£ *Quita√ß√£o (${cfg.quitacao}%):* R$ ${valor.toFixed(2)}\n\n`;
    }

    if (cfg.juncao > 0) {
        let valor = divida - divida * (cfg.juncao / 100);
        mensagem += `2Ô∏è‚É£ *Jun√ß√£o (${cfg.juncao}%):* R$ ${valor.toFixed(2)}\n\n`;
    }

    if (cfg.atraso > 0) {
        let valor = divida - divida * (cfg.atraso / 100);
        mensagem += `3Ô∏è‚É£ *Atraso (${cfg.atraso}%):* R$ ${valor.toFixed(2)}\n\n`;
    }

    mensagem += "Qual op√ß√£o prefere para negociar hoje?";
    document.getElementById("resultado").innerText = mensagem;
}

</script>

</body>
</html>
